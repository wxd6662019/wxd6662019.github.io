
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>My ls in linux | Kola&#39;s nest</title>
    <meta name="author" content="wxd666" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />


<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>KOLA&#39;S NEST</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;KOLA&#39;S NEST</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>My ls in linux</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/9/13
        </span>
        
        <span class="category">
            <a href="/categories/%E5%AE%9E%E8%B7%B5/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                实践
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/C/" style="color: #00bcd4">
                    C
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/Linux/" style="color: #ffa2c4">
                    Linux
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h1>1. stat系统调用函数</h1>
<p>用于获取指定文件的相关信息，其函数声明如下</p>
<pre><code class="language-c">#include &lt;sys/stat.h&gt;
int stat(const char *path, struct stat *buf);

/**
path：指向字符数组的指针，代表要获取信息的文件的路径名
buf：一个指向struct stat结构体的指针，由于存储拿到的文件的信息
返回值：0成功/ -1失败，失败原因如权限不够，文件不存在等
**/
</code></pre>
<p>1.1</p>
<p><code>DIR *dp = opendir(path); struct dirent *entry = readdir(dp)</code></p>
<p>利用<code>dirent</code>结构体我们可以获取某个目录下所有文件的文件名，但这里的文件名不一定是<code>stat</code>系统调用函数的第一个参数</p>
<ol>
<li>如果进程的当前工作目录就是<code>dirent</code>结构体所表示的目录（就是opendir打开的目录），那么文件名就是路径名(相对路径).</li>
<li>如果进程的当前工作目录不是<code>dirent</code>结构体所表示的目录（不是opendir打开的目录），那么&quot;<code>dirent</code>结构体目录路径/文件名&quot;才是路径名(绝对路径)。</li>
</ol>
<p>此时基于<code>dirent</code>结构体，来获取<code>stat</code>函数形参的文件路径名就有了两种办法：</p>
<ol>
<li>在子l进程中使用<code>chdir</code>函数切换进程的当前工作目录为<code>dirent</code>结构体所表示的目录，此时文件名就是路径名。</li>
<li>利用<code>dirent</code>结构体中获取的文件名，结合<code>dirent</code>结构体目录路径名，拼接得到一个绝对路径。</li>
</ol>
<p>两种方式都可以，具体用哪个看自己的需求。</p>
<p>1.2</p>
<p>函数的第二个形参是<code>*buf</code>指针，需要传入一个指向stat结构体对象的指针。该形参没有被const修饰，传入stat函数后，显然函数内部会修改指向的内容，也就是在函数内部会修改stat结构体对象。</p>
<p>1.3</p>
<p>通过man 2 stat命令，可以找到stat结构体的定义</p>
<pre><code class="language-c">struct stat &#123;
    mode_t    st_mode;          // 包含文件的类型以及权限信息
    nlink_t   st_nlink;         // 文件的硬链接数量 
    uid_t     st_uid;           // 文件所有者的用户ID
    gid_t     st_gid;           // 文件所有者组的组ID
    off_t     st_size;          // 文件的实际大小, 以字节为单位

    struct timespec st_mtim;  /* 包含文件最后修改时间的结构体对象 */
&#125;;
</code></pre>
<p>这些字段的类型都是使用别名来定义的，在64位Linux操作系统上，这些别名的类型一般是：</p>
<ol>
<li>
<p><code>mode_t</code>：一般是一个32位无符号整数。</p>
</li>
<li>
<p><code>nlink_t</code>：一般是一个64位无符号整数。</p>
</li>
<li>
<p><code>uid_t</code>：一般是一个32位无符号整数。</p>
</li>
<li>
<p><code>off_t</code>：一般是一个64位无符号整数。</p>
</li>
<li>
<pre><code class="language-c">// 最后修改时间
struct timespec &#123;
    __time_t tv_sec;  // 时间戳，秒为单位。此类型别名一般就是long类型
    __syscall_slong_t   tv_nsec;            // 纳秒 - 存储时间戳当中不足秒的部分，用于精准表示时间。此类型别名一般就是long类型
&#125;;
</code></pre>
</li>
</ol>
<p>综上，这里给出一个stat 函数的简单调用</p>
<pre><code class="language-c">// 省略了错误处理
DIR *dirp = opendir(argv[1]);
chdir(dir_name);        // 切换当前进程的工作目录为dir_name目录
struct dirent* pdirent = readdir(dirp));        // 目录项结构体, dirp是打开的dir_name目录流指针
struct stat stat_buf;       // 预先申请一个stat结构体对象
int ret = stat(pdirent-&gt;d_name, &amp;stat_buf); // 获取文件的相关信息，相当于给stat_buf结构体对象初始化
</code></pre>
<h1>2. 实现青春版ls</h1>
<p>当我们拿到<code>stat_buf</code> 这个对象时，需要解析各个成员变量，其中的<code>st_mode</code> 的低九位存储文件的读写权限， 分别与0400 0200 0100 ，如果为1，则说明有对应的<code>rwx</code> 权限</p>
<pre><code class="language-c">void set_type_mode(mode_t mode, char *tm_str)&#123;
    // 处理第一个字符，即文件类型 
    switch (mode &amp; S_IFMT) &#123;
    case S_IFBLK:   tm_str[0] = 'b';        break;
    case S_IFCHR:   tm_str[0] = 'c';        break;
    case S_IFDIR:   tm_str[0] = 'd';        break;
    case S_IFIFO:   tm_str[0] = 'p';        break;
    case S_IFLNK:   tm_str[0] = 'l';        break;
    case S_IFREG:   tm_str[0] = '-';        break;
    case S_IFSOCK:  tm_str[0] = 's';        break;
    default:        tm_str[0] = '?';        break;
    &#125;

    // 处理后续九个字符，即文件的权限信息
    // 设置拥有者的权限信息
    tm_str[1] = (mode &amp; 0400) ? 'r' : '-';
    tm_str[2] = (mode &amp; 0200) ? 'w' : '-';
    tm_str[3] = (mode &amp; 0100) ? 'x' : '-';
    // 设置拥有者组的权限                          
    tm_str[4] = (mode &amp; 0040) ? 'r' : '-';
    tm_str[5] = (mode &amp; 0020) ? 'w' : '-';
    tm_str[6] = (mode &amp; 0010) ? 'x' : '-';
    // 设置其他人的权限
    tm_str[7] = (mode &amp; 0004) ? 'r' : '-';
    tm_str[8] = (mode &amp; 0002) ? 'w' : '-';
    tm_str[9] = (mode &amp; 0001) ? 'x' : '-';
    tm_str[10] = '\0'; // 确保字符串以 null 结尾
&#125;
</code></pre>
<p>对于时间，其用<code>struct timespec st_mtim</code> 变量存储，这是一个结构体对象，具体的时间存在<code>st_mtim.tv_sec</code>中，单位是毫秒，我们需要一个时间转换函数，传参时可直接传入<code>stat_buf.st_mtime</code> ,这是一个对前者的宏，即</p>
<p><code>#define st_mtime st_mtim.tv_sec</code></p>
<p>这里要介绍一个C语言标准库函数</p>
<pre><code class="language-c">#include &lt;time.h&gt;
struct tm *localtime(const time_t *timer);
// timer ：指向时间戳变量的指针
//返回值时指向struct tm 结构体的指针
struct tm &#123;
    int tm_sec;    /* 秒 – 取值区间为[0,59] */
    int tm_min;    /* 分 - 取值区间为[0,59] */
    int tm_hour;   /* 时 - 取值区间为[0,23] */
    int tm_mday;   /* 一个月中的日期 - 取值区间为[1,31] */
    int tm_mon;    /* 月份（从一月开始，0代表一月）- 取值区间为[0,11] */
    int tm_year;   /* 年份，其值从1900开始 */
    int tm_wday;   /* 星期 – 取值区间为[0,6]，星期日为0 */
    int tm_yday;   /* 从每年的1月1日开始的天数 – 取值区间为[0,365]，1月1日为0 */
    int tm_isdst;  /* 夏令时标识符，夏令时时为正，不是夏令时时为0，不了解情况时为负 */
&#125;;
</code></pre>
<p>对上面的函数封装一下，让它在内部<strong>组合一个好的</strong>时间字符串</p>
<pre><code class="language-c">// 获取格式化的时间字符串
void set_time(time_t mtime, char *time_str)&#123;
    // 由于tm结构体中存储的是月份的整数值，我们需要的是月份字符串，所以用一个字符串数组来存储月份字符串
    const char month_arr[][10] = &#123;
        &quot;1月&quot;, &quot;2月&quot;, &quot;3月&quot;, &quot;4月&quot;, &quot;5月&quot;, &quot;6月&quot;,
        &quot;7月&quot;, &quot;8月&quot;, &quot;9月&quot;, &quot;10月&quot;, &quot;11月&quot;, &quot;12月&quot;
    &#125;;  // tm结构体当中的月份范围是[0, 11]，刚好可以适配这个数组

    // 调用localtime函数，获取tm结构体指针
    struct tm* st_tm = localtime(&amp;mtime);
    // 构建时间字符串,格式为：月份 天数 时：分
    sprintf(time_str, &quot;%s %2d %02d:%02d&quot;,
            month_arr[st_tm-&gt;tm_mon],
            st_tm-&gt;tm_mday,
            st_tm-&gt;tm_hour,
            st_tm-&gt;tm_min);
&#125;
</code></pre>
<p>对于用户和组，我们可以通过两个函数来直接拿到它的名字</p>
<pre><code class="language-c">getpwuid(stat_buf.st_uid)-&gt;pw_name  // 拥有者名
</code></pre>
<p>and</p>
<pre><code class="language-c">getgrgid(stat_buf.st_gid)-&gt;gr_name  // 拥有者组名
</code></pre>
<p>最后使用格式字符串打印即可</p>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2023 - 2024 Kola&#39;s nest
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;wxd666
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    
<script
    src="https://giscus.app/client.js"
    data-repo="wxd6662019/wxd6662019.github.io"
    data-repo-id="R_kgDOMv_QXw"
    data-category="Announcements"
    data-category-id="DIC_kwDOMv_QX84CiZrp"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin
    async
></script>





    
</body>
</html>

