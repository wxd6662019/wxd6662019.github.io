
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>TCP | Kola&#39;s nest</title>
    <meta name="author" content="wxd666" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />


<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>KOLA&#39;S NEST</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;KOLA&#39;S NEST</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>TCP</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/9/25
        </span>
        
        <span class="category">
            <a href="/categories/%E7%90%86%E8%AE%BA/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                理论
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/Network/" style="color: #00a596">
                    Network
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h1 id="tcp基本认识">TCP基本认识</h1>
<h2 id="看一看tcp的头">1. 看一看TCP的头</h2>
<p><img
src="https://cdn.xiaolincoding.com//mysql/other/format,png-20230309230534096.png" /></p>
<p><strong>Sequence_Number</strong>:
在建立连接时由计算机生成的随机数作为初始值，通过SYN包传给接收端主机，每发送一次数据，<em>累加</em>
一次该 <em>数据字节数</em>
的大小。<strong>用来解决网络包乱序问题。</strong></p>
<p><strong>Ackonwledge_Number:</strong> 指下一次 <em>期望</em>
收到的数据的序列号，发送端收到这个确认应答以后可以认为这个序号以前的数据都已经被正常接收。<strong>用来解决丢包的问题。</strong></p>
<p><strong>flag：</strong></p>
<ul>
<li>ACK：该位为1时，<em>确认应答</em>
的字段变为有效，TCP规定处理最初建立连接时的SYN包之外该位必须设置为1</li>
<li>RST： 该位为1时，表示TCP连接中出现异常必须强制断开连接</li>
<li>SYN：该位为1时，表示希望建立连接，并在其 <em>序列号</em>
的字段进行序列号初始值的设定</li>
<li>FIN：该位为1时，表示今后不会再有数据发送，希望断开连接。当通信结束希望断开连接时，通信双方的主机之间就可以相互交换FIN位为1的TCP段。</li>
</ul>
<span id="more"></span>
<h2 id="为什么需要tcp协议它工作在哪一层">2.
为什么需要TCP协议？它工作在哪一层</h2>
<p><strong>IP层</strong>是不可靠的，它不保证网络包的交付，不保证网络包的按序交付，也不保证网络包中的数据的完整性</p>
<p><img
src="https://cdn.xiaolincoding.com//mysql/other/format,png-20230309230419839.png" /></p>
<p>如果需要保障网络数据包的可靠性，那么就需要上层（传输层）的
<strong>TCP</strong> 协议来负责。</p>
<p>因为TCP是工作在 <strong>传输层</strong>的 <strong>可靠</strong>
数据传输的服务，他能确保接收端接收的网络包是
<strong>无损坏，无间隔，非冗余和按序的。</strong></p>
<h2 id="什么是tcp">3. 什么是TCP ？</h2>
<p>TCP 是<strong>面向连接的，可靠的，基于字节流</strong>
的传输层通信协议</p>
<p><img
src="https://cdn.xiaolincoding.com//mysql/other/format,png-20230309230424714.png" /></p>
<ul>
<li><strong>面向连接</strong>：一定是 <em>一对一</em>
才能连接，不能像UDP协议可以一个主机同时向多个主机发送消息，也就是一对多是无法做到的；</li>
<li><strong>可靠的</strong>：
无论网络链路中出现了怎样的链路变化，TCP都可以保证一个报文一定能够到达接收端；</li>
<li><strong>字节流</strong>：
用户消息通过TCP协议传输时，消息可能会被操作系统 <em>分组</em>
成多个的TCP报文，如果接收方的程序如果不知道 <em>消息的边界</em>
，是无法读出一个有效的用户消息的。并且TCP报文是 <em>有序的</em> ，当
<em>前一个</em>
TCP报文没有收到的时候，即使它先收到了后面的TCP报文，那么也不能扔给应用层去处理，同时对
<em>重复</em> 的TCP报文会自动丢弃。</li>
</ul>
<h2 id="什么是tcp连接">4. 什么是TCP连接？</h2>
<p>Let us check the defination of connection in RFC</p>
<blockquote>
<p>The reliablity and flow control mechanisms described above require
that TCPs initialize and maintain certain status information for each
data stream. The combination of this information, including sockets,
sequence numbers, and window sizes, is called a connection.</p>
</blockquote>
<p><strong>简而言之，用于保证可靠性和流量控制维护的某些状态信息的组合，包括socket，序列号和窗口大小，称为连接</strong></p>
<p><img
src="https://cdn.xiaolincoding.com//mysql/other/format,png-20230309230428466.png" /></p>
<p>所以我们可以知道，建立一个TCP连接是需要客户端与服务端达成上述三个信息的共识</p>
<ul>
<li><strong>Socket：</strong> 有IP地址和端口号组成</li>
<li><strong>序列号：</strong>用来解决乱序问题</li>
<li><strong>窗口大小：</strong>用来做流量控制</li>
</ul>
<h2 id="如何唯一确定一个tcp连接呢">4. 如何唯一确定一个TCP连接呢？</h2>
<p>TCP四元组可以唯一的确定一个连接，四元组包括如下：</p>
<ul>
<li><p>源地址</p></li>
<li><p>源端口</p></li>
<li><p>目的地址</p></li>
<li><p>目的端口</p>
<p><img
src="https://cdn.xiaolincoding.com//mysql/other/format,png-20230309230433082.png" /></p></li>
</ul>
<p>源地址和目的地址的字段（32位）是在IP头部中，作用是通过IP协议发送报文给对方主机。源端口和目的端口的字段（16位）是在TCP头部中，作用是告诉TCP协议应该把报文发给哪个进程</p>
<blockquote>
<p>有一个IP的服务端监听了一个端口，他的TCP的最大连接数是多少？</p>
</blockquote>
<p>服务端通常固定在某个本地端口上监听，等待客户端的连接请求。</p>
<p>因此，客户端IP和端口是可变的，其理论值计算公式如下：</p>
<p><img
src="https://cdn.xiaolincoding.com//mysql/other/format,png-20230309230436594.png" /></p>
<p>对IPv4，客户端的IP数最多为 <em>2</em> 的 <em>32</em>
次方，客户端的端口数最多为 <em>2</em> 的 <em>16</em>
次方，也就是说服务器单机最大TCP连接数，约为 <em>2</em> 的 <em>48</em>
次方。</p>
<p>当然，服务端最大并发TCP连接数远不能达到理论上限，会受以下因素影响：</p>
<ul>
<li><strong>文件描述符限制：</strong>每个TCP连接都是一个文件，如果文件描述符被占满了，会发生
Too many open files。Linux对可打开的文件描述符的数量做了三个方面的限制
<ul>
<li><strong>系统级：</strong>当前系统可打开的最大数量，通过
<code>cat /proc/sys/file-max</code> 查看</li>
<li><strong>用户级：</strong>指定用户可打开的最大数量，通过
<code>cat /etc/security/limits.conf</code> 查看</li>
<li><strong>进程级：</strong>单个进程可打开的最大数量，通过
<code>cat /proc/sys/fs/nr_open</code> 查看</li>
</ul></li>
<li><strong>内存限制：</strong>每个TCP连接都要占用一定内存，操作系统的内存是有限，如果内存资源被占满后，会发生OOM。</li>
</ul>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2023 - 2024 Kola&#39;s nest
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;wxd666
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    
<script
    src="https://giscus.app/client.js"
    data-repo="wxd6662019/wxd6662019.github.io"
    data-repo-id="R_kgDOMv_QXw"
    data-category="Announcements"
    data-category-id="DIC_kwDOMv_QX84CiZrp"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin
    async
></script>





    
</body>
</html>

